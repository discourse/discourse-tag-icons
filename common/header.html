<script type="text/discourse-plugin" version="0.8.29">
  let tagIconList = null;
  try {
    tagIconList = JSON.parse(settings.tag_icon_list);
  } catch (e) {
    return false;
  }

  const { iconHTML } = require("discourse-common/lib/icon-library");
  const getURL = require('discourse-common/lib/get-url').default;

  function iconTagRenderer(tag, params) {
    params = params || {};
    const visibleName = Handlebars.Utils.escapeExpression(tag);
    tag = visibleName.toLowerCase();
    const classes = ["discourse-tag"];
    const tagName = params.tagName || "a";
    let path;
    if (tagName === "a" && !params.noHref) {
      if (params.isPrivateMessage && Discourse.User.current()) {
        const username = params.tagsForUser
          ? params.tagsForUser
          : Discourse.User.current().username;
        path = `/u/${username}/messages/tags/${tag}`;
      } else {
        path = `/tag/${tag}`;
      }
    }
    const href = path ? ` href='${getURL(path)}' ` : "";

    if (Discourse.SiteSettings.tag_style || params.style) {
      classes.push(params.style || Discourse.SiteSettings.tag_style);
    }

  	/// Add custom tag icon from theme settings
    let tagIcon = tagIconList.find((item) => item["tag"] == tag);
  	let tagIconHTML = '';

    if (tagIcon) {
      let itemColor = tagIcon["color"] ? `style="color: ${tagIcon["color"]}"` : "";
      tagIconHTML = `<span ${itemColor} class="tag-icon">${iconHTML(tagIcon["icon"])}</span>`;
  	}
  	/// End custom tag icon

    let val =
      "<" +
      tagName +
      href +
      " data-tag-name=" +
      tag +
      " class='" +
      classes.join(" ") +
      "'>" +
      tagIconHTML + // inject tag Icon in html
      visibleName +
      "</" +
      tagName +
      ">";

    if (params.count) {
      val += " <span class='discourse-tag-count'>x" + params.count + "</span>";
    }

    return val;
  }

  api.replaceTagRenderer(iconTagRenderer);
</script>
